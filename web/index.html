<!DOCTYPE html>
<html>

<input class="pan-control" type="range" min="0" max=".99999" step=".00015" value="0" oninput="updateSlider(this.value)">
<span class="gain-value">0</span>
<button onclick="playSynth()">play synth</button>
<button onclick="playAudioFile()">play audio file</button>
<button onclick="pan2()">pan2</button>
<button onclick="changePan()">changePan</button>

<input type="text" name="position" value=0>

<script src="/bower_components/osc.js/dist/osc-browser.min.js"></script>
<script src="/bower_components/flocking/dist/flocking-all.js"></script>

<audio controls="">  
  <source src="panX test.wav" type="audio/ogg">
</audio>

<script>

  //TODO
  //have osc message start and trigger sounds

  //interpolate flocking and panX

  var panControl = document.querySelector('.pan-control');
  var panValue = document.querySelector('.gain-value');
  panValue = panControl.value;


  const context = new AudioContext();

  var channelCount = context.destination.maxChannelCount;
  context.destination.channelCount = channelCount;
  context.destination.channelCountMode = 'explicit';
  context.destination.channelInterpretation = 'discrete';
  console.log("channelCount: " + channelCount);

  context.audioWorklet.addModule('panX.js').then(() => {
    let oscillator = new OscillatorNode(context);
    oscillator.type = "sawtooth";

    let panX = new AudioWorkletNode(context, 'panX', {
      channelCount: channelCount,
      channelCountMode: 'explicit',
      channelInterpretation: 'discrete',
    });

    //master gain node to controll overall volume
    let gainNode = new GainNode(context);
    gainNode.gain.value = .34;

    oscillator.connect(panX).connect(gainNode).connect(context.destination);
    oscillator.start();
    let pan = panX.parameters.get('gain');
    updateSlider = function (value) {
      pan.setTargetAtTime(value, context.currentTime, .015);
    }

    //osc
    var oscPort = new osc.WebSocketPort({
      url: "ws://localhost:8081", // URL to your Web Socket server.
      metadata: true
    });
    oscPort.open();
    oscPort.on("message", function (oscMsg) {
      console.log("An OSC message just arrived!", oscMsg.args[0].value);
      pan.setTargetAtTime(oscMsg.args[0].value, context.currentTime, .015);
    });

    //flocking
    var environment = flock.init({
      chans: channelCount,
      outputs: channelCount
    });

    environment.start();
    var panSynthDef;

    //sounds.js
    playSynth = function () {
      sounds.playSynth();
    }

    playAudioFile = function () {
      sounds.playAudioFile();
    }

    pan2 = function () {

      panSynthDef = flock.synth({
        synthDef:
        {
          id: "panner",
          ugen: "flock.ugen.pan2",
          pan: -1.0,
          source: {
            ugen: "flock.ugen.sinOsc",
            freq: 440,
            mul: 0.06
          },
          options:
          {
            numOutputs: channelCount
          }
        }
      });

    }//pan2

    changePan = function () {
      panSynthDef.set("panner.pan", -0.1);
    }

  }); //promise
</script>

</html>